---
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
namespace: taskd
resources:
  - ../../common/taskd
  - namespace.yaml
  - pv.yaml
  - sops-secret-taskd-restic-pvc.yaml
components:
  - ../../../apps/taskd/components/pvc
  - ../../../apps/taskd/components/tls
  - ../../../apps/taskd/components/istio
  - ../../../apps/taskd/components/restic-pvc
configMapGenerator:
  - name: taskd-restic-pvc  # TODO: https://github.com/kubernetes-sigs/kustomize/issues/4402
    literals:
      - RESTIC_HOSTNAME=svc.dd.soeren.cloud
patches:
  - target:
      kind: "Certificate"
      name: "taskd"
    patch: |-
      - op: "replace"
        path: "/spec/commonName"
        value: "taskd.svc.dd.soeren.cloud"
      - op: "replace"
        path: "/spec/dnsNames"
        value:
          - "taskd.svc.dd.soeren.cloud"
  - target:
      kind: "VirtualService"
      name: "taskd"
    patch: |-
      - op: "replace"
        path: "/spec/hosts"
        value:
          - "taskd.svc.dd.soeren.cloud"
