---
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
namespace: radicale
resources:
  - namespace.yaml
  - config-cm.yaml
  - external-secret-radicale.yaml
  - external-secret-radicale-restic.yaml
  - ../../../../apps/radicale
components:
  - ../../../../apps/radicale/components/istio
  - ../../../../apps/radicale/components/istio-proxy
  - ../../../../apps/radicale/components/pvc
  - ../../../../apps/radicale/components/restic-pvc
  - ../../../../infra/unrest/components/default-config
  - ../../../../infra/unrest/components/with-random-sleep
  - ../../../../infra/unrest/components/with-timezone-berlin
patches:
  - target:
      kind: VirtualService
      name: radicale
    patch: |-
      - op: "replace"
        path: "/spec/hosts"
        value:
          - "radicale.svc.dd.soeren.cloud"
  - target:
      kind: Deployment
      name: radicale
    patch: |-
      - op: add
        path: /spec/template/spec/priorityClassName
        value: prod-default-prio
      - op: add
        path: /spec/template/spec/containers/0/volumeMounts/-
        value:
          name: config
          mountPath: /config
      - op: add
        path: /spec/template/spec/volumes/-
        value:
          name: config
          configMap:
            name: radicale
      - op: add
        path: /spec/template/spec/containers/0/volumeMounts/-
        value:
          name: users
          mountPath: /etc/radicale/users
          subPath: users
      - op: add
        path: /spec/template/spec/volumes/-
        value:
          name: users
          secret:
            secretName: radicale
            items:
              - key: RADICALE_USERS
                path: users
configMapGenerator:
  - name: "radicale-restic"
    options:
      disableNameSuffixHash: true
    literals:
      - "RESTIC_REPOSITORY=s3:https://s3.amazonaws.com/soerenschneider-restic-prod/radicale"
      - "RESTIC_HOST=svc.dd.soeren.cloud"
  - name: "resticprofile-confd"
    options:
      disableNameSuffixHash: true
    files:
      - "resticprofile-blob.yaml"
