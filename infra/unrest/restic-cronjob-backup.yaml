---
apiVersion: "batch/v1"
kind: "CronJob"
metadata:
  name: "unrest-backup"
spec:
  schedule: "0 6 * * *"
  concurrencyPolicy: "Forbid"
  jobTemplate:
    spec:
      ttlSecondsAfterFinished: 86400
      template:
        metadata:
          labels:
            app: "restic"
            app.kubernetes.io/name: "restic"
            restic/name: "unknown"
            restic/operation: "backup"
            sidecar.istio.io/inject: "false"
        spec:
          activeDeadlineSeconds: 43200
          restartPolicy: "OnFailure"
          securityContext:
            runAsUser: 16523
            runAsGroup: 16523
            fsGroup: 16523
            runAsNonRoot: true
          containers:
            - name: "unrest-backup"
              image: "ghcr.io/soerenschneider/unrest:1.1.0"
              command:
                - resticprofile
                - backup
              args: []
              imagePullPolicy: "IfNotPresent"
              securityContext:
                runAsUser: 16523
                runAsGroup: 16523
                runAsNonRoot: true
                readOnlyRootFilesystem: true
                allowPrivilegeEscalation: false
                seccompProfile:
                  type: "RuntimeDefault"
                capabilities:
                  drop:
                    - "ALL"
              env:
                - name: "RESTICPROFILE_NAME"
                  value: "default"
                - name: "RESTICPROFILE_LOCK_WAIT"
                  value: "180"
                - name: "TMPDIR"
                  value: "/tmp"
                - name: "RESTIC_CACHE_DIR"
                  value: "/tmp/restic-cache"
                - name: "RESTIC_COMPRESSION"
                  value: "max"
                - name: "K8S_NAMESPACE"
                  valueFrom:
                    fieldRef:
                      fieldPath: "metadata.namespace"
                - name: "K8S_NODE_NAME"
                  valueFrom:
                    fieldRef:
                      fieldPath: "spec.nodeName"
              envFrom: []
              resources:
                requests:
                  memory: "256Mi"
                  cpu: "20m"
                limits:
                  memory: "4G"
              volumeMounts:
                - name: "tmp"
                  mountPath: "/tmp"
                - name: "resticprofile"
                  mountPath: "/etc/resticprofile"
                - name: "resticprofile-confd"
                  mountPath: "/etc/resticprofile.d/"
          volumes:
            - name: "tmp"
              emptyDir: {}
            - name: "resticprofile"
              configMap:
                optional: true
                name: "resticprofile"
            - name: "resticprofile-confd"
              configMap:
                optional: true
                name: "resticprofile-confd"
